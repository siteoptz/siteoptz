<!DOCTYPE html>
<html>
<head>
    <title>Ultimate GA4 Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-box { background: #f0f0f0; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .result { background: #e8f5e8; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe8e8; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { background: #4CAF50; color: white; padding: 15px 25px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0; font-size: 16px; }
        .network-log { background: #2d2d2d; color: #fff; padding: 15px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîß Ultimate GA4 Connectivity Test</h1>
    
    <div class="test-box">
        <h3>Test 1: Basic Connectivity</h3>
        <button onclick="testBasicConnectivity()">Test Google Analytics Connectivity</button>
        <div id="connectivity-result"></div>
    </div>

    <div class="test-box">
        <h3>Test 2: Manual Event Send</h3>
        <button onclick="sendManualEvent()">Send Event Manually</button>
        <div id="manual-result"></div>
    </div>

    <div class="test-box">
        <h3>Test 3: Network Monitoring</h3>
        <button onclick="startNetworkMonitoring()">Start Network Monitoring</button>
        <div id="network-monitor" class="network-log">Network requests will be logged here...</div>
    </div>

    <div class="test-box">
        <h3>Test 4: Direct API Test</h3>
        <button onclick="testDirectAPI()">Test Direct GA4 API</button>
        <div id="api-result"></div>
    </div>

    <script>
        // Comprehensive logging
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        let allLogs = [];

        function logMessage(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            allLogs.push({ timestamp, message, type });
            
            if (type === 'error') {
                originalConsoleError(message);
            } else {
                originalConsoleLog(message);
            }
            
            updateNetworkMonitor();
        }

        console.log = (...args) => logMessage(args.join(' '), 'log');
        console.error = (...args) => logMessage(args.join(' '), 'error');

        function updateNetworkMonitor() {
            const monitor = document.getElementById('network-monitor');
            monitor.textContent = allLogs.slice(-10).map(log => `[${log.timestamp}] ${log.message}`).join('\n');
            monitor.scrollTop = monitor.scrollHeight;
        }

        // Test 1: Basic Connectivity
        async function testBasicConnectivity() {
            const resultDiv = document.getElementById('connectivity-result');
            resultDiv.innerHTML = '<p>Testing connectivity...</p>';

            const tests = [
                'https://www.google.com',
                'https://www.googletagmanager.com/gtag/js?id=G-06WK4MZERF',
                'https://www.google-analytics.com/g/collect'
            ];

            let results = [];
            
            for (const url of tests) {
                try {
                    const startTime = performance.now();
                    const response = await fetch(url, { 
                        method: 'HEAD', 
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    const endTime = performance.now();
                    const duration = Math.round(endTime - startTime);
                    
                    results.push(`‚úÖ ${url} - Reachable (${duration}ms)`);
                    logMessage(`Connectivity test passed: ${url}`);
                } catch (error) {
                    results.push(`‚ùå ${url} - FAILED: ${error.message}`);
                    logMessage(`Connectivity test failed: ${url} - ${error.message}`, 'error');
                }
            }

            resultDiv.innerHTML = `<div class="result">${results.join('<br>')}</div>`;
        }

        // Test 2: Manual Event Send
        function sendManualEvent() {
            const resultDiv = document.getElementById('manual-result');
            
            if (typeof gtag === 'undefined') {
                resultDiv.innerHTML = '<div class="error">‚ùå gtag is not loaded</div>';
                logMessage('Manual event test failed: gtag not available', 'error');
                return;
            }

            const eventData = {
                event_category: 'manual_test',
                event_label: 'ultimate_test',
                debug_mode: true,
                send_to: 'G-06WK4MZERF',
                timestamp: Date.now(),
                test_id: 'ultimate_' + Math.random().toString(36).substr(2, 9)
            };

            try {
                gtag('event', 'ultimate_test_event', eventData);
                resultDiv.innerHTML = '<div class="result">‚úÖ Event sent successfully</div>';
                logMessage(`Manual event sent: ${JSON.stringify(eventData)}`);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                logMessage(`Manual event failed: ${error.message}`, 'error');
            }
        }

        // Test 3: Network Monitoring
        function startNetworkMonitoring() {
            logMessage('Network monitoring started');
            
            // Intercept XMLHttpRequest
            const originalXHRSend = XMLHttpRequest.prototype.send;
            XMLHttpRequest.prototype.send = function(data) {
                const url = this._url || 'unknown';
                if (url.includes('google-analytics.com') || url.includes('googletagmanager.com')) {
                    logMessage(`XHR Request to: ${url}`);
                    logMessage(`XHR Data: ${data ? data.substring(0, 200) + '...' : 'no data'}`);
                }
                return originalXHRSend.apply(this, arguments);
            };

            const originalXHROpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function(method, url) {
                this._url = url;
                if (url.includes('google-analytics.com') || url.includes('googletagmanager.com')) {
                    logMessage(`XHR Opening: ${method} ${url}`);
                }
                return originalXHROpen.apply(this, arguments);
            };

            // Intercept fetch
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                if (typeof url === 'string' && (url.includes('google-analytics.com') || url.includes('googletagmanager.com'))) {
                    logMessage(`Fetch request to: ${url}`);
                }
                return originalFetch.apply(this, arguments);
            };

            logMessage('Network interception set up');
        }

        // Test 4: Direct API Test
        async function testDirectAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<p>Testing direct GA4 API...</p>';

            const measurementId = 'G-06WK4MZERF';
            const apiSecret = 'test'; // This won't work but we can test the endpoint
            
            const eventData = {
                client_id: 'test_client_' + Date.now(),
                events: [{
                    name: 'direct_api_test',
                    params: {
                        event_category: 'direct_test',
                        event_label: 'api_test',
                        debug_mode: true
                    }
                }]
            };

            try {
                const response = await fetch(`https://www.google-analytics.com/mp/collect?measurement_id=${measurementId}&api_secret=${apiSecret}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(eventData)
                });

                if (response.ok) {
                    resultDiv.innerHTML = '<div class="result">‚úÖ Direct API endpoint is reachable</div>';
                    logMessage('Direct API test: endpoint reachable');
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå API returned status: ${response.status}</div>`;
                    logMessage(`Direct API test failed: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå API test failed: ${error.message}</div>`;
                logMessage(`Direct API test error: ${error.message}`, 'error');
            }
        }

        // Initialize
        logMessage('Ultimate GA4 test page loaded');
        
        // Auto-start network monitoring
        setTimeout(() => {
            startNetworkMonitoring();
        }, 1000);
    </script>

    <!-- GA4 Script -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-06WK4MZERF"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-06WK4MZERF', {
            debug_mode: true
        });
        
        console.log('GA4 loaded with debug mode');
    </script>
</body>
</html>