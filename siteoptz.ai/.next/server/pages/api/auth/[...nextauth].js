"use strict";(()=>{var e={};e.id=748,e.ids=[748],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,n){return n in r?r[n]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,n)):"function"==typeof r&&"default"===n?r:void 0}}})},2079:(e,r,n)=>{n.r(r),n.d(r,{config:()=>h,default:()=>f,routeModule:()=>m});var o={};n.r(o),n.d(o,{authOptions:()=>p,default:()=>g});var t=n(1802),a=n(7153),s=n(6249);let i=require("next-auth");var l=n.n(i);let c=require("next-auth/providers/google");async function u(e){try{if(!process.env.GHL_API_KEY||!process.env.GHL_LOCATION_ID)return console.log("GHL credentials not configured"),null;let r=await fetch(`https://services.leadconnectorhq.com/contacts/search/duplicate?email=${encodeURIComponent(e)}`,{method:"GET",headers:{Authorization:`Bearer ${process.env.GHL_API_KEY}`,Version:"2021-07-28","Location-Id":process.env.GHL_LOCATION_ID}});if(!r.ok)return console.error("GHL search failed:",r.status),null;let n=await r.json();if(n.contact)return console.log("✅ Found existing GHL contact:",e),n.contact;return console.log("ℹ️ No GHL contact found for:",e),null}catch(e){return console.error("GHL search error:",e),null}}async function d(e,r,n="free"){try{if(!process.env.GHL_API_KEY||!process.env.GHL_LOCATION_ID)return console.log("GHL credentials not configured - skipping contact creation"),null;let o=await fetch("https://services.leadconnectorhq.com/contacts/",{method:"POST",headers:{Authorization:`Bearer ${process.env.GHL_API_KEY}`,Version:"2021-07-28","Content-Type":"application/json","Location-Id":process.env.GHL_LOCATION_ID},body:JSON.stringify({email:e,name:r,tags:[`siteoptz-plan-${n}`],source:"Google OAuth"})});if(!o.ok){let e=await o.text();return console.error("GHL create contact failed:",e),null}let t=await o.json();return console.log("✅ Created new GHL contact:",e,"with plan:",n),t.contact}catch(e){return console.error("GHL create contact error:",e),null}}let p={providers:[n.n(c)()({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],secret:process.env.NEXTAUTH_SECRET,session:{strategy:"jwt",maxAge:2592e3},pages:{signIn:"/login",error:"/login"},callbacks:{async signIn({user:e,account:r,profile:n}){if(console.log("\uD83D\uDD25 OAuth Sign In Attempt:",{email:e?.email,provider:r?.provider,profileEmail:n?.email}),r?.provider==="google"&&(!process.env.GOOGLE_CLIENT_ID||!process.env.GOOGLE_CLIENT_SECRET||process.env.GOOGLE_CLIENT_ID.includes("your-")||process.env.GOOGLE_CLIENT_SECRET.includes("your-")))return console.error("❌ Google OAuth not properly configured!"),console.error("Please set GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET in Vercel environment variables"),!1;if(r?.provider!=="google")return!0;if(!e?.email)return console.error("❌ No email provided from Google OAuth"),!1;try{return await u(e.email)?console.log("✅ Existing user found in GHL:",e.email):(console.log("\uD83C\uDD95 New user via OAuth, creating in GHL:",e.email),await d(e.email,e.name||"User","free")),!0}catch(e){return console.error("⚠️ Sign in callback error:",e),!0}},async redirect({url:e,baseUrl:r}){console.log("\uD83D\uDD04 Redirect callback:",{url:e,baseUrl:r});let n=e.split("#")[0];if(n.includes("/api/auth/callback/google")||n===r||n===r+"/"||n.includes("/login"))return console.log("✅ Redirecting to dashboard after OAuth sign in"),`${r}/dashboard`;if(n.includes("error=OAuthCallback"))return console.log("❌ OAuth error detected, redirecting to login with error"),`${r}/login?error=OAuthCallback`;if(n.startsWith("/"))return`${r}${n}`;try{let e=new URL(n),o=new URL(r);if(e.origin===o.origin)return n}catch(e){console.error("Invalid redirect URL:",n)}return`${r}/dashboard`},async jwt({token:e,user:r,account:n}){if(n&&r){e.accessToken=n.access_token,e.email=r.email,e.name=r.name;try{let n=await u(r.email);if(n){let r=function(e){if(!e||!Array.isArray(e))return"free";let r=e.find(e=>e.startsWith("siteoptz-plan-"));if(r){let e=r.replace("siteoptz-plan-","");return console.log("\uD83D\uDCCB Extracted plan from GHL tags:",e),e}return"free"}(n.tags||[]);e.plan=r,console.log("\uD83D\uDCCB JWT: Set user plan to:",r)}else e.plan="free",console.log("\uD83D\uDCCB JWT: No GHL contact, defaulting to free plan")}catch(r){console.error("JWT callback error:",r),e.plan="free"}}return e},session:async({session:e,token:r})=>(e.user&&(e.user.plan=r.plan||"free",e.user.email=r.email,e.user.name=r.name,console.log("\uD83D\uDCCB Session created for:",r.email,"with plan:",r.plan)),r.accessToken&&(e.accessToken=r.accessToken),e)},debug:!0,events:{async signIn({user:e,account:r,profile:n}){console.log("✅ SignIn Event:",{email:e?.email,provider:r?.provider})},async signOut({session:e,token:r}){console.log("\uD83D\uDC4B SignOut Event:",e?.user?.email)},async createUser({user:e}){console.log("\uD83C\uDD95 User Created:",e.email)},async session({session:e,token:r}){console.log("\uD83D\uDCCB Session Event:",e?.user?.email)}}},g=l()(p),f=(0,s.l)(o,"default"),h=(0,s.l)(o,"config"),m=new t.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/auth/[...nextauth]",pathname:"/api/auth/[...nextauth]",bundlePath:"",filename:""},userland:o})},7153:(e,r)=>{var n;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},1802:(e,r,n)=>{e.exports=n(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var n=r(r.s=2079);module.exports=n})();