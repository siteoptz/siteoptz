"use strict";(()=>{var e={};e.id=748,e.ids=[748],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,n)=>{Object.defineProperty(n,"l",{enumerable:!0,get:function(){return function e(n,t){return t in n?n[t]:"then"in n&&"function"==typeof n.then?n.then(n=>e(n,t)):"function"==typeof n&&"default"===t?n:void 0}}})},2079:(e,n,t)=>{t.r(n),t.d(n,{config:()=>h,default:()=>g,routeModule:()=>G});var r={};t.r(r),t.d(r,{authOptions:()=>d,default:()=>f});var o=t(1802),a=t(7153),c=t(6249);let s=require("next-auth");var i=t.n(s);let l=require("next-auth/providers/google");async function u(e){try{if(!process.env.GHL_API_KEY||!process.env.GHL_LOCATION_ID)return console.log("GHL credentials not configured"),null;let n=await fetch(`https://services.leadconnectorhq.com/contacts/search/duplicate?email=${encodeURIComponent(e)}`,{method:"GET",headers:{Authorization:`Bearer ${process.env.GHL_API_KEY}`,Version:"2021-07-28","Location-Id":process.env.GHL_LOCATION_ID}});if(!n.ok)return console.error("GHL search failed:",n.status),null;let t=await n.json();if(t.contact)return console.log("✅ Found existing GHL contact:",e),t.contact;return console.log("ℹ️ No GHL contact found for:",e),null}catch(e){return console.error("GHL search error:",e),null}}async function p(e,n,t="free"){try{if(!process.env.GHL_API_KEY||!process.env.GHL_LOCATION_ID)return console.log("GHL credentials not configured - skipping contact creation"),null;let r=await fetch("https://services.leadconnectorhq.com/contacts/",{method:"POST",headers:{Authorization:`Bearer ${process.env.GHL_API_KEY}`,Version:"2021-07-28","Content-Type":"application/json","Location-Id":process.env.GHL_LOCATION_ID},body:JSON.stringify({email:e,name:n,tags:[`siteoptz-plan-${t}`],source:"Google OAuth"})});if(!r.ok){let e=await r.text();return console.error("GHL create contact failed:",e),null}let o=await r.json();return console.log("✅ Created new GHL contact:",e,"with plan:",t),o.contact}catch(e){return console.error("GHL create contact error:",e),null}}let d={providers:[t.n(l)()({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})],secret:process.env.NEXTAUTH_SECRET,pages:{signIn:"/login",error:"/auth/error"},callbacks:{async signIn({user:e,account:n,profile:t}){if(console.log("\uD83D\uDD25 OAuth Sign In Attempt:",e.email),n?.provider!=="google")return!0;try{if(await u(e.email))console.log("✅ Existing user found in GHL:",e.email);else if(console.log("\uD83C\uDD95 New user via OAuth, creating in GHL:",e.email),!await p(e.email,e.name||"User","free")&&process.env.GHL_API_KEY)return console.error("❌ Failed to create GHL contact, blocking sign in"),!1;return!0}catch(e){if(console.error("❌ Sign in callback error:",e),!process.env.GHL_API_KEY)return console.log("⚠️ GHL not configured, allowing sign in"),!0;return!1}},redirect:async({url:e,baseUrl:n})=>e===n+"/api/auth/callback/google"||e===n+"/"?n+"/dashboard":e.startsWith("/")?`${n}${e}`:new URL(e).origin===n?e:n+"/dashboard",async jwt({token:e,user:n,account:t}){if(t&&n){e.accessToken=t.access_token;try{let t=await u(n.email);if(t){let n=function(e){if(!e||!Array.isArray(e))return"free";let n=e.find(e=>e.startsWith("siteoptz-plan-"));if(n){let e=n.replace("siteoptz-plan-","");return console.log("\uD83D\uDCCB Extracted plan from GHL tags:",e),e}return"free"}(t.tags||[]);e.plan=n,console.log("\uD83D\uDCCB JWT: Set user plan to:",n)}else e.plan="free",console.log("\uD83D\uDCCB JWT: No GHL contact, defaulting to free plan")}catch(n){console.error("JWT callback error:",n),e.plan="free"}}return e},session:async({session:e,token:n})=>(e.user&&(e.user.plan=n.plan||"free",console.log("\uD83D\uDCCB Session: User plan is:",e.user.plan)),n.accessToken&&(e.accessToken=n.accessToken),e)},debug:!1},f=i()(d),g=(0,c.l)(r,"default"),h=(0,c.l)(r,"config"),G=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/auth/[...nextauth]",pathname:"/api/auth/[...nextauth]",bundlePath:"",filename:""},userland:r})},7153:(e,n)=>{var t;Object.defineProperty(n,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,n,t)=>{e.exports=t(145)}};var n=require("../../../webpack-api-runtime.js");n.C(e);var t=n(n.s=2079);module.exports=t})();