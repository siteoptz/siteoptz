<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA4 Diagnostic Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
        }
        h1 { color: #1a73e8; text-align: center; margin-bottom: 30px; }
        .diagnostic-section {
            margin: 25px 0;
            padding: 20px;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            background: #fafbfc;
        }
        .status-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #ccc;
        }
        .status-success { border-left-color: #34a853; }
        .status-error { border-left-color: #ea4335; }
        .status-warning { border-left-color: #fbbc04; }
        .status-icon {
            margin-right: 10px;
            font-size: 18px;
            min-width: 25px;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #1557b0; }
        .code-block {
            background: #2d2d30;
            color: #cccccc;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .network-test {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .help-section {
            background: #fff3e0;
            border: 1px solid #ffcc02;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß GA4 Diagnostic Tool</h1>
        
        <div class="diagnostic-section">
            <h3>üìä Basic Diagnostics</h3>
            <div id="basic-diagnostics">
                <div class="status-item status-warning">
                    <span class="status-icon">‚è≥</span>
                    <span>Running diagnostics...</span>
                </div>
            </div>
            <button onclick="runBasicDiagnostics()">üîÑ Refresh Basic Diagnostics</button>
        </div>

        <div class="diagnostic-section">
            <h3>üåê Network Connectivity Test</h3>
            <div id="network-test">
                <div class="status-item status-warning">
                    <span class="status-icon">‚è≥</span>
                    <span>Testing network connectivity...</span>
                </div>
            </div>
            <button onclick="testNetworkConnectivity()">üîÑ Test Network</button>
        </div>

        <div class="diagnostic-section">
            <h3>üì° GA4 Script Loading Test</h3>
            <div id="script-test">
                <div class="status-item status-warning">
                    <span class="status-icon">‚è≥</span>
                    <span>Testing GA4 script loading...</span>
                </div>
            </div>
            <button onclick="testScriptLoading()">üîÑ Test Script Loading</button>
        </div>

        <div class="diagnostic-section">
            <h3>üß™ Event Sending Test</h3>
            <div id="event-test">
                <div class="status-item status-warning">
                    <span class="status-icon">‚è≥</span>
                    <span>Ready to test event sending...</span>
                </div>
            </div>
            <button onclick="sendDiagnosticEvent()">üì§ Send Diagnostic Event</button>
            <button onclick="interceptNetworkRequests()">üïµÔ∏è Monitor Network Requests</button>
        </div>

        <div class="diagnostic-section">
            <h3>‚öôÔ∏è Property & Debug Mode Check</h3>
            <div id="property-check">
                <div class="status-item">
                    <span class="status-icon">üÜî</span>
                    <span><strong>Measurement ID:</strong> G-06WK4MZERF</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">üîç</span>
                    <span id="debug-mode-status">Debug mode status: Checking...</span>
                </div>
            </div>
            <button onclick="checkPropertyAccess()">üîç Verify Property Access</button>
        </div>

        <div class="help-section">
            <h3>üÜò Common Issues & Solutions</h3>
            <div id="solutions">
                <p><strong>If events still don't appear:</strong></p>
                <ol>
                    <li>Check if you have access to the correct GA4 property (G-06WK4MZERF)</li>
                    <li>Verify your Google Analytics account permissions</li>
                    <li>Try opening DebugView in an incognito window</li>
                    <li>Wait up to 5 minutes - some events can be delayed</li>
                    <li>Check if ad blockers are blocking GA4 requests</li>
                </ol>
            </div>
        </div>

        <div class="network-test">
            <h4>üîç Live Network Monitor</h4>
            <div id="network-monitor">
                <p>Network requests will be logged here when you send events...</p>
            </div>
        </div>
    </div>

    <!-- Load GA4 with diagnostic monitoring -->
    <script>
        let networkRequests = [];
        let originalFetch = window.fetch;
        let originalXHROpen = XMLHttpRequest.prototype.open;
        let originalXHRSend = XMLHttpRequest.prototype.send;

        // Monitor all network requests
        function interceptNetworkRequests() {
            const monitor = document.getElementById('network-monitor');
            monitor.innerHTML = '<p style="color: #1a73e8;">üïµÔ∏è Network monitoring enabled. Send an event to see requests...</p>';

            // Intercept fetch requests
            window.fetch = function(...args) {
                const url = args[0];
                if (typeof url === 'string' && (url.includes('google-analytics.com') || url.includes('googletagmanager.com'))) {
                    logNetworkRequest('FETCH', url, args[1]);
                }
                return originalFetch.apply(this, args);
            };

            // Intercept XMLHttpRequest
            XMLHttpRequest.prototype.open = function(method, url, ...args) {
                this._method = method;
                this._url = url;
                if (url.includes('google-analytics.com') || url.includes('googletagmanager.com')) {
                    logNetworkRequest('XHR OPEN', url, { method });
                }
                return originalXHROpen.apply(this, [method, url, ...args]);
            };

            XMLHttpRequest.prototype.send = function(data) {
                if (this._url && (this._url.includes('google-analytics.com') || this._url.includes('googletagmanager.com'))) {
                    logNetworkRequest('XHR SEND', this._url, { method: this._method, data });
                }
                return originalXHRSend.apply(this, [data]);
            };
        }

        function logNetworkRequest(type, url, options) {
            const timestamp = new Date().toLocaleTimeString();
            const monitor = document.getElementById('network-monitor');
            const requestDiv = document.createElement('div');
            requestDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: #e8f5e8; border-radius: 5px; font-family: monospace; font-size: 12px;';
            requestDiv.innerHTML = `
                <strong>[${timestamp}] ${type}</strong><br>
                URL: ${url}<br>
                Options: ${JSON.stringify(options, null, 2)}
            `;
            monitor.appendChild(requestDiv);
            monitor.scrollTop = monitor.scrollHeight;
        }

        function runBasicDiagnostics() {
            const container = document.getElementById('basic-diagnostics');
            const diagnostics = [];

            // Check gtag availability
            if (typeof gtag !== 'undefined') {
                diagnostics.push({ status: 'success', icon: '‚úÖ', message: 'gtag function is available' });
            } else {
                diagnostics.push({ status: 'error', icon: '‚ùå', message: 'gtag function is NOT available' });
            }

            // Check dataLayer
            if (typeof dataLayer !== 'undefined' && Array.isArray(dataLayer)) {
                diagnostics.push({ status: 'success', icon: '‚úÖ', message: `dataLayer exists with ${dataLayer.length} items` });
            } else {
                diagnostics.push({ status: 'error', icon: '‚ùå', message: 'dataLayer is not available' });
            }

            // Check URL parameters
            if (window.location.search.includes('debug_mode=true')) {
                diagnostics.push({ status: 'success', icon: '‚úÖ', message: 'debug_mode=true parameter found in URL' });
            } else {
                diagnostics.push({ status: 'warning', icon: '‚ö†Ô∏è', message: 'debug_mode=true parameter NOT found in URL' });
            }

            // Check browser
            const userAgent = navigator.userAgent;
            diagnostics.push({ status: 'success', icon: 'üåê', message: `Browser: ${userAgent.includes('Chrome') ? 'Chrome' : userAgent.includes('Firefox') ? 'Firefox' : userAgent.includes('Safari') ? 'Safari' : 'Other'}` });

            // Check for ad blockers (basic check)
            if (window.ga || window.gtag || window.dataLayer) {
                diagnostics.push({ status: 'success', icon: 'üõ°Ô∏è', message: 'No obvious ad blocker interference detected' });
            } else {
                diagnostics.push({ status: 'warning', icon: 'üõ°Ô∏è', message: 'Possible ad blocker interference' });
            }

            // Update display
            container.innerHTML = diagnostics.map(d => `
                <div class="status-item status-${d.status}">
                    <span class="status-icon">${d.icon}</span>
                    <span>${d.message}</span>
                </div>
            `).join('');
        }

        async function testNetworkConnectivity() {
            const container = document.getElementById('network-test');
            container.innerHTML = '<div class="status-item status-warning"><span class="status-icon">‚è≥</span><span>Testing network connectivity...</span></div>';

            const tests = [
                { name: 'Google Analytics Script', url: 'https://www.googletagmanager.com/gtag/js?id=G-06WK4MZERF' },
                { name: 'Google Analytics Collect', url: 'https://www.google-analytics.com/collect' },
                { name: 'Google (General)', url: 'https://www.google.com' }
            ];

            const results = [];
            
            for (const test of tests) {
                try {
                    const startTime = performance.now();
                    const response = await fetch(test.url, { method: 'HEAD', mode: 'no-cors' });
                    const endTime = performance.now();
                    const duration = Math.round(endTime - startTime);
                    
                    results.push({ 
                        status: 'success', 
                        icon: '‚úÖ', 
                        message: `${test.name}: Reachable (${duration}ms)` 
                    });
                } catch (error) {
                    results.push({ 
                        status: 'error', 
                        icon: '‚ùå', 
                        message: `${test.name}: Failed - ${error.message}` 
                    });
                }
            }

            container.innerHTML = results.map(r => `
                <div class="status-item status-${r.status}">
                    <span class="status-icon">${r.icon}</span>
                    <span>${r.message}</span>
                </div>
            `).join('');
        }

        function testScriptLoading() {
            const container = document.getElementById('script-test');
            const results = [];

            // Check if GA4 script loaded
            const scripts = document.querySelectorAll('script');
            let ga4ScriptFound = false;
            scripts.forEach(script => {
                if (script.src && script.src.includes('googletagmanager.com/gtag/js')) {
                    ga4ScriptFound = true;
                    results.push({ status: 'success', icon: '‚úÖ', message: `GA4 script found: ${script.src}` });
                }
            });

            if (!ga4ScriptFound) {
                results.push({ status: 'error', icon: '‚ùå', message: 'GA4 script not found in page' });
            }

            // Check script execution
            if (typeof gtag === 'function') {
                results.push({ status: 'success', icon: '‚úÖ', message: 'gtag function is executable' });
            } else {
                results.push({ status: 'error', icon: '‚ùå', message: 'gtag function is not available' });
            }

            container.innerHTML = results.map(r => `
                <div class="status-item status-${r.status}">
                    <span class="status-icon">${r.icon}</span>
                    <span>${r.message}</span>
                </div>
            `).join('');
        }

        function sendDiagnosticEvent() {
            const container = document.getElementById('event-test');
            const timestamp = Date.now();
            
            if (typeof gtag === 'undefined') {
                container.innerHTML = '<div class="status-item status-error"><span class="status-icon">‚ùå</span><span>Cannot send event: gtag is not available</span></div>';
                return;
            }

            // Send a simple diagnostic event
            try {
                gtag('event', 'diagnostic_test', {
                    event_category: 'debug',
                    event_label: 'diagnostic_tool_test',
                    custom_parameter_1: 'test_value',
                    timestamp: timestamp,
                    debug_mode: true,
                    page_location: window.location.href,
                    page_title: document.title
                });

                container.innerHTML = `
                    <div class="status-item status-success">
                        <span class="status-icon">‚úÖ</span>
                        <span>Diagnostic event sent at ${new Date(timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-icon">‚ÑπÔ∏è</span>
                        <span>Check GA4 DebugView for 'diagnostic_test' event</span>
                    </div>
                `;

                // Log to console for debugging
                console.log('Diagnostic event sent:', {
                    event: 'diagnostic_test',
                    timestamp: timestamp,
                    gtag_available: typeof gtag !== 'undefined',
                    dataLayer_length: dataLayer ? dataLayer.length : 'N/A'
                });

            } catch (error) {
                container.innerHTML = `
                    <div class="status-item status-error">
                        <span class="status-icon">‚ùå</span>
                        <span>Error sending event: ${error.message}</span>
                    </div>
                `;
            }
        }

        function checkPropertyAccess() {
            // Update debug mode status
            const debugModeEl = document.getElementById('debug-mode-status');
            const hasDebugParam = window.location.search.includes('debug_mode=true');
            const hasDebugInStorage = localStorage.getItem('ga_debug_mode') === 'true';
            
            let debugStatus = 'disabled';
            if (hasDebugParam) debugStatus = 'enabled via URL parameter';
            else if (hasDebugInStorage) debugStatus = 'enabled via localStorage';
            
            debugModeEl.textContent = `Debug mode status: ${debugStatus}`;
            
            // Provide instructions for checking property access
            const solutionsEl = document.getElementById('solutions');
            solutionsEl.innerHTML = `
                <p><strong>To verify you have access to GA4 property G-06WK4MZERF:</strong></p>
                <ol>
                    <li>Go to <a href="https://analytics.google.com" target="_blank">Google Analytics</a></li>
                    <li>Check if you can see the property "SiteOptz" or property ID "G-06WK4MZERF"</li>
                    <li>If not visible, you may need access permissions from the property owner</li>
                    <li>Try accessing DebugView: <a href="https://analytics.google.com/analytics/web/#/a/p/debugview/" target="_blank">GA4 DebugView</a></li>
                </ol>
                <p><strong>Alternative measurement IDs to try:</strong></p>
                <div class="code-block">
// If G-06WK4MZERF doesn't work, try creating a test property:
// 1. Create a new GA4 property in your Google Analytics account
// 2. Replace G-06WK4MZERF with your new measurement ID
// 3. Test with your own property
                </div>
            `;
        }

        // Initialize diagnostics when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß GA4 Diagnostic Tool loaded');
            
            // Enable network monitoring immediately
            interceptNetworkRequests();
            
            setTimeout(() => {
                runBasicDiagnostics();
                testScriptLoading();
            }, 1000);
            
            setTimeout(() => {
                testNetworkConnectivity();
            }, 2000);
            
            checkPropertyAccess();
        });
    </script>

    <!-- GA4 Script -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-06WK4MZERF"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-06WK4MZERF', {
            debug_mode: true
        });
        
        console.log('GA4 initialized with measurement ID: G-06WK4MZERF');
    </script>
</body>
</html>